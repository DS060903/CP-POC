{% extends "base.html" %}

{% block title %}Journal Review - TMHNA Financial Intelligence Portal{% endblock %}
{% block breadcrumb %}Journal Review{% endblock %}

{% block content %}
<div class="journal-review">
    <!-- Page Header -->
    <div class="page-header">
        <div class="page-header-content">
            <div class="page-header-left">
                <h1>Journal Entry Review</h1>
                <p class="page-subtitle">
                    Review and validate AI-classified journal entries with ML-generated confidence scores
                </p>
            </div>
            <div class="page-header-actions">
                <button class="btn btn-secondary">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                        <polyline points="7 10 12 15 17 10"></polyline>
                        <line x1="12" y1="15" x2="12" y2="3"></line>
                    </svg>
                    Export
                </button>
            </div>
        </div>
    </div>

    <!-- Filters Panel -->
    <div class="filters-panel">
        <form method="GET" action="{{ url_for('journal_review') }}" class="filters-form">
            <div class="filter-group">
                <label class="filter-label">ERP Source</label>
                <select name="source_erp" multiple class="filter-select" size="3">
                    {% for source in sources %}
                    <option value="{{ source }}" {% if source in selected_sources %}selected{% endif %}>
                        {{ source }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="filter-group">
                <label class="filter-label">Min. Confidence</label>
                <div class="filter-slider-group">
                    <input type="range" name="confidence" id="confidence" 
                           min="0" max="1" step="0.05" value="{{ min_confidence }}"
                           class="filter-slider">
                    <span class="filter-value" id="confidence-display">{{ "%.0f"|format(min_confidence * 100) }}%</span>
                </div>
            </div>
            
            <div class="filter-group">
                <label class="filter-label">&nbsp;</label>
                <div class="filter-checkbox-group">
                    <input type="checkbox" name="anomalies_only" id="anomalies_only" 
                           class="filter-checkbox" {% if anomalies_only %}checked{% endif %}>
                    <label for="anomalies_only" class="filter-checkbox-label">Anomalies Only</label>
                </div>
            </div>
            
            <div class="filter-actions">
                <button type="submit" class="btn btn-primary">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"></polygon>
                    </svg>
                    Apply Filters
                </button>
                <a href="{{ url_for('journal_review') }}" class="btn btn-secondary">Reset</a>
            </div>
        </form>
    </div>

    <!-- Results Summary -->
    <div class="card" style="margin-bottom: var(--space-4);">
        <div class="card-body" style="padding: var(--space-3) var(--space-5);">
            <div style="display: flex; align-items: center; justify-content: space-between;">
                <div style="display: flex; align-items: center; gap: var(--space-3);">
                    <span style="font-weight: 600; color: var(--gray-900);">{{ entries|length }} Entries</span>
                    <span style="color: var(--gray-400);">|</span>
                    <span style="font-size: var(--text-sm); color: var(--gray-500);">
                        {% if selected_sources %}Filtered by: {{ selected_sources|join(', ') }}{% endif %}
                        {% if min_confidence > 0 %} â€¢ Min confidence: {{ "%.0f"|format(min_confidence * 100) }}%{% endif %}
                        {% if anomalies_only %} â€¢ Anomalies only{% endif %}
                    </span>
                </div>
            </div>
        </div>
    </div>

    <!-- Entry Cards -->
    {% if entries %}
    <div class="entries-grid">
        {% for entry in entries %}
        <div class="entry-card {% if entry.is_anomaly %}entry-anomaly{% endif %}">
            <div class="entry-card-header">
                <div class="entry-card-meta">
                    <span class="entry-id">{{ entry.entry_id }}</span>
                    <span class="entry-erp-badge">{{ entry.source_erp }}</span>
                    <span class="entry-amount">{{ entry.amount }}</span>
                </div>
                <div style="font-size: var(--text-sm); color: var(--gray-600); max-width: 400px; text-overflow: ellipsis; overflow: hidden; white-space: nowrap;">
                    {{ entry.description }}
                </div>
            </div>
            
            <div class="entry-card-body">
                <div class="entry-section">
                    <div class="entry-section-title">
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <ellipse cx="12" cy="5" rx="9" ry="3"></ellipse>
                            <path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"></path>
                            <path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"></path>
                        </svg>
                        Original ERP Data
                    </div>
                    <div class="entry-data-grid">
                        <span class="entry-data-label">ERP System</span>
                        <span class="entry-data-value">{{ entry.source_erp }}</span>
                        
                        <span class="entry-data-label">Company Code</span>
                        <span class="entry-data-value">{{ entry.source_company_code }}</span>
                        
                        <span class="entry-data-label">Local Account</span>
                        <span class="entry-data-value"><code>{{ entry.local_account_code }}</code></span>
                        
                        <span class="entry-data-label">Vendor</span>
                        <span class="entry-data-value">{{ entry.vendor_name }}</span>
                        
                        <span class="entry-data-label">Amount</span>
                        <span class="entry-data-value" style="font-weight: 600;">{{ entry.amount }}</span>
                    </div>
                </div>
                
                <div class="entry-section">
                    <div class="entry-section-title">
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline>
                        </svg>
                        AI Classification
                    </div>
                    
                    <div class="classification-result">
                        <div class="classification-account">
                            <span class="account-code">{{ entry.suggested_account }}</span>
                            <span class="account-name">{{ entry.suggested_account_name }}</span>
                        </div>
                        <div class="confidence-badge {% if entry.confidence_raw >= 0.85 %}confidence-high{% elif entry.confidence_raw >= 0.7 %}confidence-medium{% else %}confidence-low{% endif %}">
                            {{ entry.confidence }}
                        </div>
                    </div>
                    
                    <div style="margin-bottom: var(--space-3);">
                        <span style="font-size: var(--text-xs); color: var(--gray-500); display: block; margin-bottom: var(--space-2);">Top Candidates</span>
                        <div class="suggestions-list">
                            {% for suggestion in entry.top_3 %}
                            <span class="suggestion-chip">{{ suggestion.account }} ({{ "%.0f"|format(suggestion.confidence * 100) }}%)</span>
                            {% endfor %}
                        </div>
                    </div>
                    
                    {% if entry.is_anomaly %}
                    <div class="status-flag status-anomaly">
                        <span class="status-text">Anomaly: {{ entry.anomaly_reason }}</span>
                    </div>
                    {% else %}
                    <div class="status-flag status-normal">
                        <span class="status-text">Normal</span>
                    </div>
                    {% endif %}
                </div>
            </div>
            
            <div class="entry-card-footer">
                <a href="{{ url_for('drill_down', entry_id=entry.entry_id) }}" class="btn btn-primary btn-sm">
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="11" cy="11" r="8"></circle>
                        <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                        <line x1="11" y1="8" x2="11" y2="14"></line>
                        <line x1="8" y1="11" x2="14" y2="11"></line>
                    </svg>
                    View Details
                </a>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="card">
        <div class="card-body">
            <div class="empty-state">
                <div class="empty-state-icon">ðŸ“‹</div>
                <div class="empty-state-title">No Entries Found</div>
                <div class="empty-state-desc">No journal entries match your current filter criteria. Try adjusting the filters.</div>
                <a href="{{ url_for('journal_review') }}" class="btn btn-primary">Reset Filters</a>
            </div>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script>
    // Update confidence display when slider changes
    const slider = document.getElementById('confidence');
    const display = document.getElementById('confidence-display');
    
    if (slider && display) {
        slider.addEventListener('input', function() {
            display.textContent = Math.round(this.value * 100) + '%';
        });
    }
</script>
{% endblock %}
