{% extends "base.html" %}

{% block title %}Dashboard - TMHNA Financial Intelligence Portal{% endblock %}
{% block breadcrumb %}Dashboard{% endblock %}

{% block content %}
<div class="dashboard">
    <!-- Page Header -->
    <div class="page-header">
        <div class="page-header-content">
            <div class="page-header-left">
                <h1>
                    Financial Intelligence Dashboard
                    {% if persona_role == 'Controller' %}
                    <span class="page-header-badge">Full Access</span>
                    {% else %}
                    <span class="page-header-badge warning">Filtered View</span>
                    {% endif %}
                </h1>
                <p class="page-subtitle">
                    Real-time overview of financial data health and ML classification performance for <strong>{{ persona_company }}</strong>
                </p>
            </div>
            <div class="page-header-actions">
                <button class="btn btn-secondary">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                        <polyline points="7 10 12 15 17 10"></polyline>
                        <line x1="12" y1="15" x2="12" y2="3"></line>
                    </svg>
                    Export Report
                </button>
                <a href="{{ url_for('journal_review') }}" class="btn btn-primary">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                        <polyline points="14 2 14 8 20 8"></polyline>
                    </svg>
                    Review Entries
                </a>
            </div>
        </div>
    </div>

    <!-- KPI Cards -->
    <div class="kpi-grid">
        <div class="kpi-card kpi-primary">
            <div class="kpi-header">
                <div class="kpi-icon">üìÑ</div>
                <div class="kpi-trend neutral">
                    <span>‚Äî</span> Current
                </div>
            </div>
            <div class="kpi-value">{{ stats.total_entries }}</div>
            <div class="kpi-label">Total Journal Entries</div>
            <div class="kpi-sublabel">Across all ERP systems</div>
        </div>
        
        <div class="kpi-card {% if stats.anomalies > 0 %}kpi-warning{% else %}kpi-success{% endif %}">
            <div class="kpi-header">
                <div class="kpi-icon">‚ö†Ô∏è</div>
                {% if stats.anomalies > 0 %}
                <div class="kpi-trend down">
                    <span>‚Üë</span> {{ stats.anomaly_percent }}%
                </div>
                {% else %}
                <div class="kpi-trend up">
                    <span>‚úì</span> Clean
                </div>
                {% endif %}
            </div>
            <div class="kpi-value">{{ stats.anomalies }}</div>
            <div class="kpi-label">Anomalies Detected</div>
            <div class="kpi-sublabel">Requiring manual review</div>
        </div>
        
        <div class="kpi-card kpi-info">
            <div class="kpi-header">
                <div class="kpi-icon">üéØ</div>
                <div class="kpi-trend neutral">
                    <span>‚Äî</span> Target: 85%
                </div>
            </div>
            <div class="kpi-value">{{ stats.avg_confidence }}</div>
            <div class="kpi-label">Avg Classification Confidence</div>
            <div class="kpi-sublabel">ML model accuracy</div>
        </div>
        
        <div class="kpi-card kpi-success">
            <div class="kpi-header">
                <div class="kpi-icon">‚úÖ</div>
                <div class="kpi-trend up">
                    <span>‚úì</span> Good
                </div>
            </div>
            <div class="kpi-value">{{ stats.high_confidence }}</div>
            <div class="kpi-label">High Confidence Entries</div>
            <div class="kpi-sublabel">‚â•85% classification confidence</div>
        </div>
    </div>

    <!-- Dashboard Grid -->
    <div class="dashboard-grid">
        <!-- Entries by Account Chart -->
        <div class="grid-col-6">
            <div class="chart-card">
                <div class="chart-header">
                    <div class="chart-title">Entries by TMHNA Account</div>
                    <div class="chart-actions">
                        <button class="btn btn-ghost btn-sm">
                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <circle cx="12" cy="12" r="1"></circle>
                                <circle cx="19" cy="12" r="1"></circle>
                                <circle cx="5" cy="12" r="1"></circle>
                            </svg>
                        </button>
                    </div>
                </div>
                <div class="chart-body">
                    <div id="chart-accounts" class="chart-container"></div>
                </div>
            </div>
        </div>
        
        <!-- Confidence Distribution Chart -->
        <div class="grid-col-6">
            <div class="chart-card">
                <div class="chart-header">
                    <div class="chart-title">Classification Confidence Distribution</div>
                    <div class="chart-actions">
                        <button class="btn btn-ghost btn-sm">
                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <circle cx="12" cy="12" r="1"></circle>
                                <circle cx="19" cy="12" r="1"></circle>
                                <circle cx="5" cy="12" r="1"></circle>
                            </svg>
                        </button>
                    </div>
                </div>
                <div class="chart-body">
                    <div id="chart-confidence" class="chart-container"></div>
                </div>
            </div>
        </div>

        <!-- High-Risk Anomalies Table -->
        <div class="grid-col-12">
            <div class="table-card">
                <div class="table-header">
                    <div class="table-title">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path>
                            <line x1="12" y1="9" x2="12" y2="13"></line>
                            <line x1="12" y1="17" x2="12.01" y2="17"></line>
                        </svg>
                        High-Risk Anomalies
                        {% if high_risk_entries %}
                        <span class="table-count">{{ high_risk_entries|length }} items</span>
                        {% endif %}
                    </div>
                    <a href="{{ url_for('journal_review', anomalies_only='on') }}" class="btn btn-secondary btn-sm">
                        View All Anomalies
                    </a>
                </div>
                
                {% if high_risk_entries %}
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Entry ID</th>
                            <th>ERP Source</th>
                            <th>Description</th>
                            <th style="text-align: right;">Amount</th>
                            <th>Risk Reason</th>
                            <th style="text-align: right;">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for entry in high_risk_entries %}
                        <tr class="row-anomaly">
                            <td class="col-id">{{ entry.entry_id }}</td>
                            <td>
                                <span class="table-badge table-badge-erp">{{ entry.source_erp }}</span>
                            </td>
                            <td>{{ entry.description }}</td>
                            <td class="col-amount">{{ entry.amount }}</td>
                            <td>
                                <span class="table-badge table-badge-warning">{{ entry.reason }}</span>
                            </td>
                            <td class="col-actions">
                                <a href="{{ url_for('drill_down', entry_id=entry.entry_id) }}" class="btn btn-primary btn-sm">
                                    Investigate
                                </a>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% else %}
                <div class="card-body">
                    <div class="alert-card alert-success">
                        <div class="alert-icon">‚úì</div>
                        <div class="alert-content">
                            <div class="alert-title">All Clear</div>
                            <div class="alert-message">No high-risk anomalies detected. All transactions are within normal parameters.</div>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="grid-col-12">
            <div class="card">
                <div class="card-header">
                    <div class="card-title">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"></polygon>
                        </svg>
                        Quick Actions
                    </div>
                </div>
                <div class="card-body">
                    <div class="quick-actions">
                        <a href="{{ url_for('journal_review') }}" class="quick-action-card">
                            <div class="quick-action-icon">üìù</div>
                            <div class="quick-action-content">
                                <div class="quick-action-title">Review Journal Entries</div>
                                <div class="quick-action-desc">Browse and filter all classified entries</div>
                            </div>
                            <div class="quick-action-arrow">‚Üí</div>
                        </a>
                        <a href="{{ url_for('journal_review', anomalies_only='on') }}" class="quick-action-card">
                            <div class="quick-action-icon">üîç</div>
                            <div class="quick-action-content">
                                <div class="quick-action-title">Focus on Anomalies</div>
                                <div class="quick-action-desc">Review flagged transactions only</div>
                            </div>
                            <div class="quick-action-arrow">‚Üí</div>
                        </a>
                        <a href="{{ url_for('model_performance') }}" class="quick-action-card">
                            <div class="quick-action-icon">üìä</div>
                            <div class="quick-action-content">
                                <div class="quick-action-title">Model Performance</div>
                                <div class="quick-action-desc">View AI/ML classification metrics</div>
                            </div>
                            <div class="quick-action-arrow">‚Üí</div>
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Design system colors
    const colors = {
        primary: '#EB0A1E',
        primaryLight: '#FEE2E2',
        secondary: '#0F172A',
        success: '#059669',
        successLight: '#D1FAE5',
        warning: '#D97706',
        warningLight: '#FEF3C7',
        gray: '#6B7280',
        grayLight: '#F3F4F6'
    };

    // Chart config
    const chartConfig = {
        responsive: true,
        displayModeBar: false
    };

    const chartLayout = {
        paper_bgcolor: 'transparent',
        plot_bgcolor: 'transparent',
        font: { 
            family: 'Inter, system-ui, sans-serif', 
            size: 12,
            color: '#374151'
        },
        margin: { l: 10, r: 10, t: 10, b: 10 }
    };

    // Accounts Bar Chart
    const accountsData = {{ top_accounts | tojson }};
    const accountLabels = Object.keys(accountsData);
    const accountValues = Object.values(accountsData);

    Plotly.newPlot('chart-accounts', [{
        x: accountValues,
        y: accountLabels,
        type: 'bar',
        orientation: 'h',
        marker: {
            color: colors.primary,
            line: {
                color: colors.primary,
                width: 0
            }
        },
        hovertemplate: '<b>%{y}</b><br>Entries: %{x}<extra></extra>'
    }], {
        ...chartLayout,
        margin: { l: 180, r: 20, t: 20, b: 40 },
        xaxis: { 
            title: { text: 'Number of Entries', font: { size: 11 } },
            gridcolor: '#E5E7EB',
            zerolinecolor: '#E5E7EB'
        },
        yaxis: { 
            automargin: true,
            tickfont: { size: 11 }
        },
        bargap: 0.3
    }, chartConfig);

    // Confidence Histogram
    const confidenceValues = {{ confidence_values | tojson }};

    Plotly.newPlot('chart-confidence', [{
        x: confidenceValues,
        type: 'histogram',
        nbinsx: 10,
        marker: {
            color: colors.success,
            line: {
                color: colors.success,
                width: 0
            }
        },
        hovertemplate: 'Confidence: %{x:.0%}<br>Count: %{y}<extra></extra>'
    }], {
        ...chartLayout,
        margin: { l: 50, r: 20, t: 20, b: 50 },
        xaxis: { 
            title: { text: 'Confidence Score', font: { size: 11 } },
            range: [0, 1],
            tickformat: '.0%',
            gridcolor: '#E5E7EB',
            zerolinecolor: '#E5E7EB'
        },
        yaxis: { 
            title: { text: 'Count', font: { size: 11 } },
            gridcolor: '#E5E7EB',
            zerolinecolor: '#E5E7EB'
        },
        bargap: 0.05
    }, chartConfig);
</script>
{% endblock %}
